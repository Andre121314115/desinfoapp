<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Detector de Desinformaci√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <header>Detector de Desinformaci√≥n</header>

  <main>
    <p>
      Ingresa un titular y texto de una noticia. El sistema analizar√° su nivel de veracidad
      utilizando inteligencia artificial (Gemini 2.5 Flash con b√∫squeda en la web) y mostrar√° el puntaje de riesgo.
    </p>

    <label for="source">Fuente / Medio</label>
    <input id="source" placeholder="Ej: Diario de Huancayo" />

    <label for="title">T√≠tulo</label>
    <input id="title" placeholder="Ej: El sol saldr√° por el oeste ma√±ana" />

    <label for="body">Cuerpo</label>
    <textarea id="body" placeholder="Pega aqu√≠ el contenido de la noticia"></textarea>

    <button id="btnAnalyze">Analizar</button>

    <div id="result" class="result" style="display:none"></div>

    <!-- üìä M√âTRICAS -->
    <section class="metrics-wrap" aria-label="M√©tricas de an√°lisis">
      <div class="metrics-grid">
        <article class="metric-card">
          <div class="metric-kpi" id="kpiTotal">0</div>
          <div class="metric-label">An√°lisis totales</div>
        </article>
        <article class="metric-card">
          <div class="metric-kpi" id="kpiAvgScore">0.0</div>
          <div class="metric-label">Score promedio</div>
        </article>
        <article class="metric-card">
          <div class="metric-kpi" id="kpiAvgLatency">0 ms</div>
          <div class="metric-label">Latencia media</div>
        </article>
        <article class="metric-card">
          <div class="metric-kpi" id="kpiHighRisk">0</div>
          <div class="metric-label">Alto riesgo (‚â•75)</div>
        </article>
        <article class="metric-card">
          <div class="metric-kpi small" id="kpiVerdicts">‚Äî</div>
          <div class="metric-label">Veredictos (C/D/F/NV)</div>
        </article>
      </div>
      <div class="metrics-note muted">* C: cre√≠ble, D: dudosa, F: falsa, NV: no verificable</div>
    </section>

    <div class="top-actions">
      <h2>Historial de an√°lisis</h2>
      <div>
        <input id="search" placeholder="Buscar..." class="input-search" />
        <button id="btnReload" class="btn-secondary">Actualizar</button>
        <button id="btnExport" class="btn-success">Exportar CSV</button>
      </div>
    </div>

    <div id="history" class="history">
      <p class="muted">A√∫n no hay an√°lisis registrados.</p>
    </div>

    <!-- üöÄ NUEVO BLOQUE: Subida de Dataset -->
    <section class="upload-section">
      <h2>Subir Dataset</h2>
      <input type="file" id="datasetFile" accept=".csv, .xlsx" />
      <button onclick="uploadDataset()">Cargar Dataset</button>
      <p id="uploadMessage" class="muted"></p>
    </section>

  </main>

  <script>
    // Cambia esto a tu dominio en producci√≥n, ej: "https://api.tu-dominio.com"
    const API = "http://localhost:3000";

    const $ = (q)=>document.querySelector(q);
    const btn = $("#btnAnalyze");
    const resultBox = $("#result");
    const historyBox = $("#history");

    btn.addEventListener("click", async ()=>{
      const data = {
        source: $("#source").value.trim(),
        title: $("#title").value.trim(),
        body: $("#body").value.trim()
      };
      if(!data.title && !data.body) return alert("Ingresa al menos t√≠tulo o cuerpo.");

      btn.disabled = true;
      btn.textContent = "Analizando...";

      try {
        const res = await fetch(API + "/analyze", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(data)
        });
        const json = await res.json();
        if(!json.ok) throw new Error(json.error || "Error en an√°lisis");

        const { score, labels, rationale, verdict, evidence } = json.result;

        const verdictBadgeColor =
          verdict === "falsa" ? "#dc2626" :
          verdict === "dudosa" ? "#d97706" :
          verdict === "no_verificable" ? "#64748b" : "#16a34a";

        resultBox.style.display = "block";
        resultBox.innerHTML = `
          <div class="score">
            Score: ${score}
            <span class="verdict-badge" style="background:${verdictBadgeColor}">
              ${String(verdict || '').toUpperCase() || "‚Äî"}
            </span>
          </div>
          <div><strong>Etiquetas:</strong> ${
            (labels||[]).map(x=>`<span class="pill">${x}</span>`).join(" ") || "‚Äî"
          }</div>
          <div class="mt-8"><strong>Explicaci√≥n:</strong> ${rationale || "‚Äî"}</div>
          <div class="mt-8"><strong>Evidencia:</strong>
            <ul class="evidence-list">
              ${
                (evidence||[]).map(ev => `
                  <li>
                    <div class="claim"><em>${ev.claim || "‚Äî"}</em> ‚Äî <b>${ev.assessment || "incierto"}</b></div>
                    <div class="sources">
                      ${(ev.sources||[]).slice(0,3).map(u=>`<a href="${u}" target="_blank" rel="noopener">${u}</a>`).join("<br/>") || "‚Äî"}
                    </div>
                  </li>
                `).join("") || "<li>‚Äî</li>"
              }
            </ul>
          </div>
        `;
        await loadHistory();
      } catch(e) {
        console.error(e);
        alert("Error al conectar con la API");
      } finally {
        btn.disabled = false;
        btn.textContent = "Analizar";
      }
    });

    // --- üì§ FUNCI√ìN NUEVA: subir dataset ---
   function uploadDataset() {
    const fileInput = document.getElementById('datasetFile');
    const file = fileInput.files[0];
    if (!file) return alert('Selecciona un archivo');

    const formData = new FormData();
    formData.append('file', file); // ‚úÖ CORREGIDO (antes: 'dataset')

    const headers = new Headers();
    const userPass = btoa('admin:1234'); // mismo usuario y contrase√±a del backend
    headers.append('Authorization', 'Basic ' + userPass);

    fetch(API + '/upload-dataset', { method: 'POST', body: formData, headers })
      .then(res => res.json())
      .then(data => {
          document.getElementById('uploadMessage').innerText = data.message;
          console.log("‚úÖ Respuesta del backend:", data);
      })
      .catch(err => {
          console.error("‚ùå Error subiendo dataset:", err);
          document.getElementById('uploadMessage').innerText = "Error al subir el dataset.";
      });
  }
    // --- Historial + M√©tricas ---
    async function loadHistory(q="") {
      try {
        const res = await fetch(API + "/history?q=" + encodeURIComponent(q));
        const json = await res.json();
        if(!json.ok) throw new Error("Fallo en /history");
        const arr = json.items || [];
        renderMetrics(arr);

        if(!arr.length){
          historyBox.innerHTML = `<p class="muted">Sin resultados.</p>`;
          return;
        }

        const rows = arr.map(x => {
          const verdict = x.verdict || "‚Äî";
          const verdictColor =
            verdict === "falsa" ? "#dc2626" :
            verdict === "dudosa" ? "#d97706" :
            verdict === "no_verificable" ? "#64748b" : "#16a34a";

          return `
            <tr>
              <td>${new Date(x.created_at).toLocaleString()}</td>
              <td>${x.source || "‚Äî"}</td>
              <td>${x.title || "‚Äî"}</td>
              <td style="font-weight:600;color:${x.score>75?"#dc2626":x.score>50?"#d97706":"#16a34a"}">${x.score}</td>
              <td><span class="verdict-chip" style="background:${verdictColor}">${String(verdict).toUpperCase()}</span></td>
              <td>${(x.labels||[]).join(", ")}</td>
              <td>${x.rationale || "‚Äî"}</td>
            </tr>
          `;
        }).join("");

        historyBox.innerHTML = `
          <table>
            <thead><tr>
              <th>Fecha</th><th>Fuente</th><th>T√≠tulo</th><th>Score</th><th>Veredicto</th><th>Etiquetas</th><th>Explicaci√≥n</th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>
          <p class="muted">Total: ${json.total}</p>
        `;
      } catch(e) {
        console.error(e);
        historyBox.innerHTML = `<p class="muted">No se pudo cargar historial.</p>`;
        renderMetrics([]);
      }
    }

    function renderMetrics(items){
      const total = items.length;
      const avg = total ? (items.reduce((s,x)=>s+(Number(x.score)||0),0)/total) : 0;
      const lat = total ? (items.reduce((s,x)=>s+(Number(x.latency_ms)||0),0)/total) : 0;
      const high = items.filter(x => (Number(x.score)||0) >= 75).length;

      const counts = items.reduce((acc, x)=>{
        const v = (x.verdict || "nv").toLowerCase();
        if(v.startsWith("cre")) acc.c++;
        else if(v.startsWith("dud")) acc.d++;
        else if(v.startsWith("fal")) acc.f++;
        else acc.nv++;
        return acc;
      }, {c:0,d:0,f:0,nv:0});

      $("#kpiTotal").textContent = total;
      $("#kpiAvgScore").textContent = avg.toFixed(1);
      $("#kpiAvgLatency").textContent = `${Math.round(lat)} ms`;
      $("#kpiHighRisk").textContent = high;
      $("#kpiVerdicts").textContent = `C:${counts.c} ‚Ä¢ D:${counts.d} ‚Ä¢ F:${counts.f} ‚Ä¢ NV:${counts.nv}`;
    }

    $("#btnReload").addEventListener("click", ()=> loadHistory($("#search").value.trim()));
    $("#btnExport").addEventListener("click", ()=> window.open(API + "/export/csv", "_blank"));
    $("#search").addEventListener("keyup", e=>{
      if(e.key==="Enter") loadHistory($("#search").value.trim());
    });

    loadHistory();
    
  </script>
</body>
</html>
